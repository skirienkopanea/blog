---
layout: post
title:  "How to set up a Linux server"
date:   2021-11-16 12:00:00 +0200
categories: unix
tags: ubuntu linux server
---
{% include math.html %}
<!--more-->

# Table of Contents
- [Table of Contents](#table-of-contents)
  - [Renting a (virtual) server](#renting-a-virtual-server)
  - [Logging in the server](#logging-in-the-server)
    - [Create a user](#create-a-user)
    - [SSH Login](#ssh-login)
      - [Disable root login](#disable-root-login)
      - [Login with public key](#login-with-public-key)
      - [Password login](#password-login)
      - [Monitoring successful login attempts](#monitoring-successful-login-attempts)
      - [Banning bruteforce attempts with fail2ban](#banning-bruteforce-attempts-with-fail2ban)
  - [Downloading and running a dynamic website (node app)](#downloading-and-running-a-dynamic-website-node-app)
    - [Clone git repository](#clone-git-repository)
    - [Detaching sessions](#detaching-sessions)
    - [PM2](#pm2)
  - [Periodic commands](#periodic-commands)
  - [Getting a domain and SSL certificates for https (http secure)](#getting-a-domain-and-ssl-certificates-for-https-http-secure)
  - [Making an https web application](#making-an-https-web-application)
    - [Remote coding on Visual Studio Code](#remote-coding-on-visual-studio-code)
    - [Transfering files](#transfering-files)
    - [https node app](#https-node-app)
  - [Installing a database](#installing-a-database)
  - [Making backups](#making-backups)
  - [Hosting game servers](#hosting-game-servers)
    - [Linux Game Server Manager](#linux-game-server-manager)
      - [Counter-Strike 1.6](#counter-strike-16)
    - [Minecraft](#minecraft)


## Renting a (virtual) server
* Although you could host a website from your home computer (after dealing with opening the router ports and possibly dynamic IPs...), it's generally more convienent, and cheaper, to outsource a machine that is always on.
* Many options, as in sellers and operative systems, exist today, and regardless of the seller, my favorite server operative system is Ubuntu, the most popular linux distribution (distro).
* The reasons I prefer Ubuntu/Linux:
  * Since it's the most popular Linux distro, there's generally more support and more software available
  * It's a Linux OS, which means it is "[Unix]({{ site.baseurl }}/unix/2021/02/07/unix-terminal-cheatsheet.html)" (as a hipster computer aficionado I like to use UNIX terminals)
  * Linux servers are provided by most sellers and are cheaper than Windows (fewer switching costs in the future)
* I'm currently using the cheapest cloud server offered by Hetzner. Apparently it's a virtual CPU what I have access to, but from a practical point of view, it works and feels like if it was a regular Linux machine always connected to the internet. Therefore this detail is beyond the scope of this tutorial.

## Logging in the server
* After you rented the server for the first time you should receive login credentials from the seller, such as a `root` username and a temporary password.
* Yo should be able to access to the server via some built-in console link for the web browser in the seller website. And you'll probably be prompted to change your password after you sign in for the first time
  * **Attention**: Do not use a weak password (yet, at least). There are many bots out there bruteforcing random IPs on the internet and as a matter of fact, I get like 10 loging attempts from bots per second since the beginning
* Now that we are in, we should create a non-admin user from which we will log in (via the terminal, the IDE, etc) as we will shortly disable `root` (which is admin) log in via "SSH" (secure shell, once we get in the server via the non-admin user we can log in as admin, this is safer because bots target the `root` user, but they are less likely to target your non-admin username)

### Create a user
* (In the built-in terminal in the web browser for the server) Create the non-admin user "alex" (for the sake of this tutorial) with the following command:

```bash
useradd -m alex
```

-m creates a home directory for alex in `/home/alex` which alex owns and has full rights

* To be able to log in for the first time as alex we need to add a password:

```bash
passwd alex
```

* Which will prompt you to type and retype the password. At least for now, try to make it secure, as bots might still be able to bruteforce the username and a weak password.

### SSH Login
* Sweet, we have a non-admin users that we can use to log in via ssh. Let's just give it a try by "sshing" to the server IP (which for the sake of this tutorial is 157.90.233.167) **from our local machine**:
  * For Linux terminals:

```bash
ssh alex@157.90.233.167
```

* If you don't have a Unix terminal, aka Windows, then install the `wsl` program for the command line. It's Window Subsystem Linux and you can find it on Windows appstore. Then go to the command line (`cmd`) and enter `wsl`. Then follow the tutorial for Linux

* You should be prompted to enter your password `alex@157.90.233.167's password: `, but if instead you get the message `ssh: connect to host 157.90.233.167 port 22: Connection refused` you may run this on the server:
  * Make sure you have `openssh-server` installed
  * As root, run `sudo service ssh start`
  * Then from the local machine try to ssh into the IP with the user we created

#### Disable root login
* People can still try to bruteforce `root` passwords. Since we can at least log in via the non-admin user `alex`, let's first disable ssh root logins
* In the server, as root, run `vim /etc/ssh/sshd_config` and edit `PermitRootLogin yes` line to `PermitRootLogin no`.
  * Since we last logged in as `alex`, just run `su` to log in as root (and type the prompted password).
  * If you need help with vim type `vimtutor` (for this you only need to press A (to insert) use the arrows to navigate the pointer, make the changes, then press Escape key, then type `:wq` and hit Enter key.
  * To activate this change, as root, run `service ssh restart`

#### Login with public key
* A public-private key log in is a type of encryption handshake where the party that needs to send something (i.e. login API) looks up the public key of the requesting party, such that that public key is used to encrypt a message that only the other party can decrypt with his private key. For more details check [Computer Networks Security Notes]({{ site.baseurl }}/downloads/CSE1405_security.pdf)
* We'll generate a public key for the local machine with the following command:

```bash
ssh-keygen
```

* Youll be prompted for the location of the file, accept the default or give your own location. You may skip the passphrase but it's more secure not to (I skip it).
* You should recive a text with the location for `id_rsa` and `id_rsa.pub` (if the default algorithm was RSA), such as `/home/localmachineuser/.ssh`
* `cd` into that location, then copy your **public key** to the server with:

```bash
ssh-copy-id -i id_rsa.pub alex@157.90.233.167
```

* Your private key must be only known to you, so that if senders use your public key and an attacker interferes the message, it wont be able to decrypt it since he needs your secret/private key.
* After hitting the command you'll be prompted to enter the password, then it'll notify you of the number of keys added (1) and it'll suggest you to `ssh 'alex@157.90.233.167'`
* If you are on `wsl` it'll complain that the private key is unprotected. If it indeed is a problem and doesn't let you `ssh alex@157.90.233.167`, then fix it with the code below based on [this]({{ site.baseurl }}/downloads/chmod-chown-wsl.pdf)

```bash
# You are might be already in /mnt/c, so get outta there before unmounting it
cd /
sudo umount /mnt/c
sudo mount -t drvfs C: /mnt/c -o metadata
# now you can ssh alex@157.90.233.167
```

#### Password login
* Although we can log in directly with the public key (you should have noticed that it doesnt prompt you for the password anymore), people (hackers or specially bots) from other devices can still request a password ssh login. We don't use it and it poses a security threat, we block the possibility to login via ssh with password by editing `PasswordAuthentication yes` to `PasswordAuthentication no` from the `/etc/ssh/sshd_config` file:
  * In the server, as root `vim /etc/ssh/sshd_config` and make the change
  * Then `service ssh restart` to implement the new configuraion.
* Now if someone wants to log in to `ssh alex@157.90.233.167` and doesn't have the private key of alex, or hasn't stored his public key on the server for alex user, then it will receive `alex@157.90.233.167: Permission denied (publickey).`

#### Monitoring successful login attempts
* If you want to double check that the IPs or access style (public key instead of password, which users, etc) matches your expectations then as `root` in the server run this:

```bash
cat /var/log/auth.log | egrep Accepted
```

* Keep in mind that older logs are stored in other files such as auth.log.1, auth.log.2, etc.

#### Banning bruteforce attempts with fail2ban
* Just innstall it as root `apt install fail2ban` 
* The default settings should do the job for `ssh` login bans, but feel free to explore the rest of the program.
* If you want to be sure `vim /etc/fail2ban/jail.local` and in the text editor, type in the following text after [sshd]

```
[sshd]
enabled = true
```

* You can double check it's status with `fail2ban-client status sshd`

## Downloading and running a dynamic website (node app)
* We have a server to share things with others right? Well, I do. Let's download a simple web app as example


### Clone git repository
* 3D app
* and run it

### Detaching sessions
* Then run it, exit and see it

### PM2 
* Since the application may crash, we can use a tool that will automatically restart it
* `pm2 start app.js`

## Periodic commands
* Alternative could be to run a script every 5 min, we have crontabs for that:
* Crontab a tmux that starts pm2 in the event that the server crashes and gets rebooted.
* Crontab as root fo night reboots (just to reset the memory, for maintenace)

## Getting a domain and SSL certificates for https (http secure)
* IPs are long, lets share
* Getting certificates
  * certbot certonly --expand -d kpan.nl,www.kpan.nl

## Making an https web application
### Remote coding on Visual Studio Code
* Install the "Remote - SSH" extension 
* If you encounter an error when connecting, you may need to enable socket forwarding on your SSH Host's sshd config. To do so `vim /etc/ssh/sshd_config` and make sure to have `AllowStreamLocalForwarding yes`
* You can follow the steps in these [link1](https://code.visualstudio.com/docs/remote/ssh) [link2](https://code.visualstudio.com/docs/remote/troubleshooting)
* If you've been following the whole tutorial from `wsl`, you will notice that "sshing" won't work because the ssh that VSC is using is not from `wsl`.
* Copy the keys you made from `wsl` to windows preferred location for ssh keys `C:\Users\username\.ssh`
* Double check in windows command line that you can run `ssh alex@157.90.233.167`, if that works, proceed to Connect to a host `alex@157.90.233.167` via VSC.

### Transfering files
* We can code the thing comfortably via VSC, but we can also copy something from our local machine to the server directly.
* `scp sourcepath host:destinationpath`

### https node app
* js code for 3D


## Installing a database
  * Install database
  * Make a chatroom app with db

## Making backups
* Make (disk) backups of the server
  * With a scp script?

## Hosting game servers
### Linux Game Server Manager 
#### Counter-Strike 1.6
### Minecraft